---
import BaseLayout from '../../layouts/BaseLayout.astro';
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const blogDir = path.join(process.cwd(), 'src/content/blog');

  if (!fs.existsSync(blogDir)) {
    return [];
  }

  const files = fs.readdirSync(blogDir).filter(f => f.endsWith('.md'));

  return files.map(file => {
    const slug = file.replace('.md', '');
    return { params: { slug } };
  });
}

const { slug } = Astro.params;
const blogDir = path.join(process.cwd(), 'src/content/blog');
const filePath = path.join(blogDir, `${slug}.md`);
const content = fs.readFileSync(filePath, 'utf-8');

// Parse frontmatter
const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
const meta: Record<string, any> = {};

if (frontmatterMatch) {
  frontmatterMatch[1].split('\n').forEach(line => {
    const [key, ...valueParts] = line.split(':');
    if (key && valueParts.length) {
      let value = valueParts.join(':').trim();
      if (value.startsWith('"') && value.endsWith('"')) {
        value = value.slice(1, -1);
      }
      if (value.startsWith('[') && value.endsWith(']')) {
        try {
          value = JSON.parse(value.replace(/'/g, '"'));
        } catch {}
      }
      if (value === 'true') value = true;
      if (value === 'false') value = false;
      meta[key.trim()] = value;
    }
  });
}

// Get markdown content (after frontmatter)
const markdownContent = content.replace(/^---\n[\s\S]*?\n---\n/, '');

// Simple markdown to HTML conversion
function parseMarkdown(md: string): string {
  return md
    // Headers
    .replace(/^### (.*$)/gm, '<h3 class="font-display text-xl font-semibold text-[var(--color-text-primary)] mt-8 mb-4">$1</h3>')
    .replace(/^## (.*$)/gm, '<h2 class="font-display text-2xl font-semibold text-[var(--color-text-primary)] mt-10 mb-4">$1</h2>')
    .replace(/^# (.*$)/gm, '<h1 class="font-display text-3xl font-bold text-[var(--color-text-primary)] mb-6">$1</h1>')
    // Bold and italic
    .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // Code blocks
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="bg-[var(--color-bg-secondary)] p-4 rounded-lg overflow-x-auto my-6"><code class="text-sm">$2</code></pre>')
    // Inline code
    .replace(/`([^`]+)`/g, '<code class="bg-[var(--color-bg-secondary)] px-1.5 py-0.5 rounded text-sm">$1</code>')
    // Lists
    .replace(/^- (.*$)/gm, '<li class="ml-4 mb-2">$1</li>')
    .replace(/^(\d+)\. (.*$)/gm, '<li class="ml-4 mb-2">$2</li>')
    // Horizontal rule
    .replace(/^---$/gm, '<hr class="my-8 border-[var(--color-border)]" />')
    // Paragraphs (lines with content that aren't already wrapped)
    .replace(/^(?!<[hpulo]|<li|<pre|<hr|<code)(.+)$/gm, '<p class="text-[var(--color-text-secondary)] leading-relaxed mb-4">$1</p>')
    // Clean up empty paragraphs
    .replace(/<p[^>]*>\s*<\/p>/g, '')
    // Wrap consecutive list items
    .replace(/(<li.*<\/li>\n?)+/g, '<ul class="list-disc list-inside mb-6">$&</ul>');
}

const htmlContent = parseMarkdown(markdownContent);

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
---

<BaseLayout
  title={`${meta.title} - Blog`}
  description={meta.description}
>
  <article class="py-20">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Back link -->
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-sm text-[var(--color-text-muted)] hover:text-[var(--color-accent)] transition-colors mb-8"
      >
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Blog
      </a>

      <!-- Header -->
      <header class="mb-12">
        <div class="flex items-center gap-3 mb-4">
          <time class="text-sm text-[var(--color-text-muted)]">
            {formatDate(meta.date)}
          </time>
          {meta.featured && (
            <span class="px-2 py-0.5 rounded-full bg-[var(--color-accent)]/10 text-[var(--color-accent)] text-xs font-medium">
              Featured
            </span>
          )}
        </div>

        <h1 class="font-display text-4xl sm:text-5xl font-bold text-[var(--color-text-primary)] mb-4">
          {meta.title}
        </h1>

        <p class="text-xl text-[var(--color-text-secondary)]">
          {meta.description}
        </p>

        {meta.tags && Array.isArray(meta.tags) && (
          <div class="flex flex-wrap gap-2 mt-6">
            {meta.tags.map((tag: string) => (
              <span class="px-3 py-1 rounded-full bg-[var(--color-bg-secondary)] text-sm text-[var(--color-text-muted)]">
                #{tag}
              </span>
            ))}
          </div>
        )}
      </header>

      <!-- Content -->
      <div class="prose prose-lg max-w-none" set:html={htmlContent} />

      <!-- Footer -->
      <footer class="mt-16 pt-8 border-t border-[var(--color-border)]">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
          <a
            href="/blog"
            class="text-[var(--color-accent)] hover:underline"
          >
            View all posts
          </a>
          <div class="flex items-center gap-4">
            <span class="text-sm text-[var(--color-text-muted)]">Share:</span>
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(meta.title)}&url=${encodeURIComponent(Astro.url.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="text-[var(--color-text-muted)] hover:text-[var(--color-accent)] transition-colors"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </a>
            <a
              href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="text-[var(--color-text-muted)] hover:text-[var(--color-accent)] transition-colors"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
              </svg>
            </a>
          </div>
        </div>
      </footer>
    </div>
  </article>
</BaseLayout>
