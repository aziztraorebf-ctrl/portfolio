---
import BaseLayout from '../../layouts/BaseLayout.astro';
import fs from 'node:fs';
import path from 'node:path';

// Read all blog posts
const blogDir = path.join(process.cwd(), 'src/content/blog');
let posts: any[] = [];

if (fs.existsSync(blogDir)) {
  const files = fs.readdirSync(blogDir).filter(f => f.endsWith('.md'));

  posts = files.map(file => {
    const content = fs.readFileSync(path.join(blogDir, file), 'utf-8');
    const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);

    if (frontmatterMatch) {
      const frontmatter = frontmatterMatch[1];
      const meta: Record<string, any> = {};

      frontmatter.split('\n').forEach(line => {
        const [key, ...valueParts] = line.split(':');
        if (key && valueParts.length) {
          let value = valueParts.join(':').trim();
          // Remove quotes
          if (value.startsWith('"') && value.endsWith('"')) {
            value = value.slice(1, -1);
          }
          // Parse arrays
          if (value.startsWith('[') && value.endsWith(']')) {
            value = JSON.parse(value.replace(/'/g, '"'));
          }
          // Parse booleans
          if (value === 'true') value = true;
          if (value === 'false') value = false;
          meta[key.trim()] = value;
        }
      });

      const slug = file.replace('.md', '');
      return { ...meta, slug };
    }
    return null;
  }).filter(Boolean).sort((a, b) =>
    new Date(b.date).getTime() - new Date(a.date).getTime()
  );
}

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
---

<BaseLayout
  title="Blog - Portfolio"
  description="Technical articles, project retrospectives, and lessons learned from AI-orchestrated development."
>
  <!-- Hero Section -->
  <section class="relative py-20 overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b from-[var(--color-bg-secondary)] to-transparent"></div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12 animate-fade-in">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-sm text-[var(--color-text-muted)] hover:text-[var(--color-accent)] transition-colors mb-8"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Home
        </a>

        <h1 class="font-display text-4xl sm:text-5xl md:text-6xl font-bold text-[var(--color-text-primary)] mb-4">
          Blog
        </h1>

        <p class="text-xl text-[var(--color-text-secondary)] max-w-2xl mx-auto">
          Technical articles, project retrospectives, and lessons learned
          from building software with AI orchestration.
        </p>
      </div>
    </div>
  </section>

  <!-- Blog Posts -->
  <section class="py-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      {posts.length === 0 ? (
        <div class="text-center py-12">
          <p class="text-[var(--color-text-muted)]">No blog posts yet. Check back soon!</p>
        </div>
      ) : (
        <div class="space-y-8">
          {posts.map((post: any) => (
            <a
              href={`/blog/${post.slug}`}
              class="card-vault p-8 block group"
            >
              <div class="flex items-start justify-between gap-4 mb-4">
                <div class="flex items-center gap-3">
                  <time class="text-sm text-[var(--color-text-muted)]">
                    {formatDate(post.date)}
                  </time>
                  {post.featured && (
                    <span class="px-2 py-0.5 rounded-full bg-[var(--color-accent)]/10 text-[var(--color-accent)] text-xs font-medium">
                      Featured
                    </span>
                  )}
                </div>
              </div>

              <h2 class="font-display text-2xl font-semibold text-[var(--color-text-primary)] mb-3 group-hover:text-[var(--color-accent)] transition-colors">
                {post.title}
              </h2>

              <p class="text-[var(--color-text-secondary)] mb-4">
                {post.description}
              </p>

              {post.tags && Array.isArray(post.tags) && (
                <div class="flex flex-wrap gap-2">
                  {post.tags.map((tag: string) => (
                    <span class="px-2 py-1 rounded bg-[var(--color-bg-secondary)] text-xs text-[var(--color-text-muted)]">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}

              <div class="mt-4 flex items-center gap-1 text-sm text-[var(--color-accent)] opacity-0 group-hover:opacity-100 transition-opacity">
                Read article
                <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </div>
            </a>
          ))}
        </div>
      )}
    </div>
  </section>
</BaseLayout>
